%%
%% Capítulo 3: Protocolo ZigBee
%%

\mychapter{Segurança no padão IEEE 802.15.4 e ZigBee}
\label{Cap:seguranca}

Como visto anteriormente neste texto, a camada MAC do padrão IEEE 802.15.4 implementa alguns recursos que são utilizados pelo protocolo
ZigBee nas camadas de rede e aplicação. Um desses recursos são os serviços de segurança.

IEEE 802.15.4 define o algorítmo de encriptação para ser usado quando os dados forem cifrados para serem transmitidos, no entanto, o padrão
não especifica como as chaves têm de ser gerenciadas ou que tipo de políticas de autenticação têm de ser aplicadas. Esses problemas são
tratados nas camadas superiores que são gerênciadas por tecnologias tais como o ZigBee.\cite{segzigbee} 

\section{Um visão geral da segurança no IEEE 802.15.4}

O algorítmo de encriptação utilizado é o \textbf{AES (Advanced Encryption Standard)} com uma chave de tamanho de 128 bits (16 bytes). 
É importante contar com um único tipo de método de encriptação devido ao fato de que a maioria dos tranceptores 802.15.4/ZigBee têm 
um design específico de hardware para lidar com esse trabalho em nível eletrônico (dispositivos de baixo recursos embutidos).

\begin{figure}[htbp!]
	\begin{center}
		\fbox{\includegraphics[width=0.5\linewidth]
		{figuras/mac802154_0med}}
		\caption{Quadro MAC do padrão IEEE 802.15.4}
		\label{Fig:mac802154_0med}
	\end{center}
\end{figure}

O Algorítmo AES não é somente utilizado para encriptar a informação mas também para validar os dados que estão sendo enviados. Este
conceito é denominado de Integridade de Dados e é alcançado utilizando um Código de Integridade de Mensagem, (em inglês MIC) que é
adicionado à mensagem. Este código garante integridade no cabeçalho MAC e carga de dados anexada. É criado encriptando partes do frame
MAC do IEEE utilizando a chave da rede, assim se for recebida uma mensagem de um nó não confiável, poderá ser analisado que o MIC gerado
para a mensagem enviada não corresponde àquele que seria gerado utilizando a mensagem com a chave secreta corrente, e então a mensagem é
descartada. O MIC ou MAC (Message Authenticantion Code) pode ter tamanhos distintos: 32, 64, 128 bits, entretanto é sempre criado
utilizando o algorítmo AES de 128 bits. Seu tamanho é apenas a quantidade de bits que são anexadas a cada frame. Quanto maior, mais seguro
(apesar da menor carga de dados que a mensagem pode ter). A segurança de dados é realizada pela encriptação do campo de carga dados (payload)
com a chave de 128 bits.

\section{Insights de segurança do 802.15.4} 

Existem três campos no frame MAC do padrão IEEE 802.15.4 que são relacionados com a segurança:

\begin{itemize}
	\item \textbf{Frame control:} localizado no cabeçalho MAC
	\item \textbf{Controle de segurança auxiliar:} localizado no cabeçalho MAC
	\item \textbf{Carga(payload) de Dados:} localizada no campo de carga do MAC
\end{itemize}

O frame de \textbf{Controle de Segurança Auxiliar} é habilitado somente se o subcampo de \textbf{Segurança Habilitada} do \textbf{Frame de 
controle} estiver ligado. Este cabeçalho especial tem 3 campos:

\begin{itemize}
	\item \textbf{Controle de Segurança (1B):} especifica que tipo de proteção é utilizada.
	\item \textbf{Contador de Frame: (4B)} é um contador fornecido pela fonte do frame atual para proteger a mensagem contra repetição
	      de proteção. Por esta razão cada mensagem tem uma única ID sequência representada por este campo. 
	\item \textbf{Identificador de chave (0-9B):} especifica a informação necessária para saber que chave nós estamos usando com o nó que
	estamos nos comunicando.
\end{itemize}

O controle de segurança é o local onde a nossa política de segurança global é configurada. Utilizando os 2 primeiros bits (campos de nível
de segurança) escolhe-se o que será encriptado e quão longa a chave será:

\begin{figure}[htbp!]
	\begin{center}
		\fbox{\includegraphics[width=0.5\linewidth]
		{figuras/mac8021540med}}
		\caption{Segurança na camada MAC do padrão IEEE 802.15.4}
		\label{Fig:mac8021540med}
	\end{center}
\end{figure}

\begin{table}[htb] % [htb]-> here, top, bottom
   \centering   % tabela centralizada
   \footnotesize       % tamanho da fonte 
   \setlength{\arrayrulewidth}{2\arrayrulewidth}  % espessura da  linha
   \setlength{\belowcaptionskip}{4pt}  % espaço entre caption e tabela
   \caption{Tabela com as respectivas chaves para o tipo de encriptação de acordo com os bits do nível de segurança}
   \begin{tabular}{|l|l|l|l|} % c=center, l=left, r=right 
      \hline
      0x00 & Sem segurança &  & Dados não encriptados, autenticidade dos dados não validada\\
      \hline
      0x01 & AES-CBC-MAC-32 & MIC-32 & Dados não encriptados, autenticidade dos dados validada\\
      \hline
      0x02 & AES-CBC-MAC-64 & MIC-64 & Dados não encriptados, autenticidade dos dados validada\\
      \hline
      0x03 & AES-CBC-MAC-128 & MIC-128 & Dados não encriptados, autenticidade dos dados validada\\
      \hline
      0x04 & AES-CTR & ENC & Dados encriptados, autenticidade dos dados não validada\\
      \hline
      0x05 & AES-CCM-32 & AES-CCM-32 & Dados encriptados, autenticidade dos dados validada\\
      \hline
      0x06 & AES-CCM-64 & AES-CCM-64 & Dados encriptados, autenticidade dos dados validada\\
      \hline
      0x07 & AES-CCM-128  & AES-CCM-128 & Dados encriptados, autenticidade dos dados validada\\
      \hline
   \end{tabular}
   \label{tab:encriptacao}
\end{table}

O valor \textbf{0x00} configura a não encriptação, então nem os dados são encriptados (sem confidencialidade de dados) nem a autenticidade
é validada. De \textbf{0x01} à \textbf{0x03} os dados são autenticados utilizando a mensagem de autenticação de código (MAC) encriptada. O
valor \textbf{0x04} encripta a carga de dados, certificando a confidencialidade de dados. Os valores de \textbf{0x05} à \textbf{0x07} 
certificam que os dados tenham confidencialidade e autenticidade.

%inserir tabela

O subcampo do modo de identificação de chave configura o tipo (implícito ou explícito) que a chave deve ser utilizada pelo destinatário e o
remetente. Possíveis valores são:

\begin{figure}[htbp!]
	\begin{center}
		\fbox{\includegraphics[width=0.5\linewidth]
		{figuras/mac802154}}
		\caption{Segurança na camada MAC do padrão IEEE 802.15.4}
		\label{Fig:mac802154}
	\end{center}
\end{figure}

\begin{itemize}
	\item \textbf{0:} O ID da chave é implicita para o remetente e destinatário (não é especificada na mensagem).
	\item \textbf{1:} O ID da chave é determinada explicitamente pelo index de chave de 1 Byte vindo do campo identificador de chave e do
	      \textbf{macDefaultKeySource}.
	\item \textbf{2:} O ID da chave é determinado explicitamente pelo index de chave de 1 Byte e os 4 Bytes da fonte de chave 
	      (Key Source).
	\item \textbf{2:} O ID da chave é determinado explicitamente pelo index de chave de 1 Byte e os 8 Bytes da fonte de chave 
	      (Key Source).
\end{itemize}

Como mencionado anteriormente, o campo /textbf{identificador de chave} é configurado quando o subcampo de modo de identificador de chave
é diferente de zero. O subcampo fonte da chave (key source) especifica quem originou o grupo de chave. O index da chave (Subcampo de controle
de chave) ajuda a identificar chaves diferentes chaves de uma fonte de chave (key source) específica

O campo de carga de dados (payload data) pode ter três diferentes configurações dos campos de segurança previamente definidos:

\begin{itemize}
	\item \textbf{AES-CTR:} Todos os dados são encriptados utilizando a chave definida de 128 bits e o algorítmo AES. O contador de frame
	      configura uma única ID de mensagem, e o contador de chave (key counter) no subcampo de controle de chave é utilizado pela
	      camada de aplicação se o valor máximo do frame counter é atingido. 
	\item \textbf{AES-CBC-MAC:} O \textbf{MAC} (Código de autenticidade de mensagem) é anexado ao final da carga de dados (data payload).
	      Seu tamanho depende do nível de segurança especificado no campo de política de segurança (Security Policy). O MAC é criado
	      encriptando informação do cabeçalho MAC do 802.15.4 e da carga de dados.
	\item \textbf{AES-CCM:} É a mistura dos métodos definidos anteriormente. Os subcampos correspondem com o modo \textbf{AES-CTR} mais
	      o subcampo extra do \textbf{AES-CBC-MAC} encriptado. 
\end{itemize}

\section{A lista de controle de acesso}

Cada transceptor 802.15.4 tem q gerenciar uma lista de controle para os seus \textit{"irmãos confiáveis"} juntamente com a política de
segurança. Por esta razão, cada nó tem que controlar sua própria \textbf{Lista de Controle de Acesso (ACL)} que guarda os seguintes campos:

\begin{itemize}
	\item \textbf{Endereço (Address):} Endereço do nó que se deseja comunicar. 
	\item \textbf{Suite de segurança:} A política de segurança que está sendo utilizada (AEC-CTR, AES-CCM-64, AES-CCM-128,,...).
	\item \textbf{Chave:} A chave de 128 bits utilizada no algorítmo AES.
	\item \textbf{Último vetor inicial(IV) e countador de repetição:} Ambos estão no mesmo campo. O último IV é utilizado pela fonte e o
	      contador de repetição pelo destino como ID de mensagem em função de se evitar ataques repetidos.
\end{itemize}

Quando um nó quer enviar uma mensagem para um nó específico ou recebe um pacote, ele irá procurar na \textbf{ACL} para verificar se o nó 
é um \textbf{irmão confiável} ou não. Se for, o nó utilizará o dado contido na coluna específica para aplicar as medidas de segurança. Caso o
nó não esteja na lista ou sua mensagem é rejeitada ou um processo de autenticação se dará início.

\section{Segurança ZigBee}

O ZigBee implementa duas camadas extras de segurança acima do padrão 802.15.4: as camadas de segurança de \textbf{rede} e \textbf{aplicação}.
Todas as políticas de segurança confiam na encriptação do algorítmo AES de 128 bits, assim a arquitetura de hardware previamente implementada
para o nível de link (camada MAC) é ainda válida. Existem três tipos de chave: master, link e de rede.

\begin{itemize}
	\item \textbf{Master Keys:} São pré-instaladas em cada nó. Sua função é manter confidencial a troca de \textbf{Chaves de Link} entre
	      dois nós no \textbf{Processo de Estabelecimento de Chave (SKKE)}. 
	\item \textbf{Chaves de Link:} São únicas entre cada par de nós. Essas chaves são gerenciadas pelo nível de aplicação. São utilizadas
	      para encriptar toda a informação entre cada dois dispositivos, por essa razão mais recursos de memória são necessários em cada
	      dispositivo. Geralmente essa chave não constuma ser usada.
	\item \textbf{Chaves de Rede:} É uma chave única de 128 bits compartilhada ao longo dos dispositivos na rede. É gerado por um centro
	      de confiança e re-gerada em diferentes intervalos. Casa nó precisa pegar sua chave de rede para ingressar em uma rede. Uma vez
	      que o centro de confiança decida mudar a chave de rede, a nova chave é espalhada na rede utilizando a antiga chave de rede.
	      Uma vez que essa nova chave é atualizada em um dispositivo, seu contador de frame é inicializado em zero. Este centro de
	      confiança é normalmente o coordenador da rede, entretanto, pode ser que seja um dispositivo dedicado. Ele tem apenas que
	      autenticar e validar cada dispositivo que tenta entrar na rede.
\end{itemize}

Cada par de dispositivos podem ter configurados tanto as chaves de rede quanto as de link. Nesse caso a chave de link é sempre utilizada
(mais segurança, mais memória é necessária). Existem dois tipos de política de segurança que o centro de confiança pode seguir:

\begin{itemize}
	\item \textbf{Modo Comercial:} O centro de confiança compartilha as chaves \textbf{master} e de \textbf{link} com qualquer
	      dispositivo na rede. Este modo requer alto recurso de memória. Oferece um modelo completo e centralizado para controle de
	      segurança de chave.
	\item \textbf{Modo Residencial:} O centro de confiança compartilha apenas a \textbf{chave de rede} (é o modo ideal quando
	      dispositivos embarcados tem de lidar com esta tarefa devido aos baixo recursos que eles tem). Este é o modo normalmente
	      escolhido para o modelo de redes de sensores sem fio.
\end{itemize}

\begin{figure}[htbp!]
	\begin{center}
		\fbox{\includegraphics[width=0.5\linewidth]
		{figuras/modocomercial}}
		\caption{Política de segurança do modo comercial}
		\label{Fig:modocomercial}
	\end{center}
\end{figure}

\begin{figure}[htbp!]
	\begin{center}
		\fbox{\includegraphics[width=0.5\linewidth]
		{figuras/modoresidencial}}
		\caption{Política de segurança do modo residencial}
		\label{Fig:modoresidencial}
	\end{center}
\end{figure}